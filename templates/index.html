<<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Gerador de Or√ßamentos</title>
</head>
<body>
    <div class="container">
        <h1>Gerador de Or√ßamentos</h1>
        <h2>{{ empresa.nome }}</h2>

        <form action="/verificar" method="post">
            <label for="cliente_nome">Nome do Cliente:</label>
            <input type="text" id="cliente_nome" name="cliente_nome" required>

            <label for="data_orcamento">Data do Or√ßamento:</label>
            <input type="text" id="data_orcamento" name="data_orcamento" value="{{ data_hoje }}" required>

        <div class="label-com-botao">
            <label for="servicos_inclusos">Servi√ßos Inclusos (um por linha):</label>
            <button type="button" id="btn-mic" title="Usar ditado por voz">üé§</button>
        </div>
            <small class="mic-instruction">Ou clique no microfone para falar</small>
            <textarea id="servicos_inclusos" name="servicos_inclusos" rows="6" required placeholder="Ex: Instala√ß√£o do motor principal&#10;Manuten√ß√£o do sistema de refrigera√ß√£o"></textarea>

            <label for="valor_total">Valor Total (R$):</label>
            <input type="text" id="valor_total" name="valor_total" placeholder="Ex: 1500,00" required>

            <label for="forma_pagamento">Forma de Pagamento:</label>
            <input type="text" id="forma_pagamento" name="forma_pagamento" value="A combinar" required>

            <button type="submit">Verificar e Gerar Or√ßamento (.docx)</button>
        </form>
    </div>
    <script>
    // Verifica se o navegador suporta a Web Speech API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const micButton = document.getElementById('btn-mic');
    const servicesTextarea = document.getElementById('servicos_inclusos');

    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        let isRecognizing = false;

        // Configura√ß√µes do reconhecimento de voz
        recognition.continuous = true;
        recognition.lang = 'pt-BR';
        recognition.interimResults = true;


        // ##### FUN√á√ÉO PARA PROCESSAR COMANDOS DE VOZ AQUI #####
    
        function processarComandos(texto) {
            let textoProcessado = texto;
            // Usei express√µes regulares (regex) para substituir os comandos
            // O 'gi' no final significa 'global' (substituir todas as ocorr√™ncias) e 'case-insensitive' (ignorar mai√∫sculas/min√∫sculas)
            textoProcessado = textoProcessado.replace(/\s+v√≠rgula/gi, ',');
            textoProcessado = textoProcessado.replace(/\s+ponto/gi, '.');
            textoProcessado = textoProcessado.replace(/\s+ponto de interroga√ß√£o/gi, '?');
            textoProcessado = textoProcessado.replace(/\s+ponto de exclama√ß√£o/gi, '!');
            textoProcessado = textoProcessado.replace(/nova linha/gi, '\n');
            textoProcessado = textoProcessado.replace(/pr√≥xima linha/gi, '\n');
            return textoProcessado;
        }


        // Evento de clique no bot√£o do microfone
        micButton.addEventListener('click', () => {
            if (!isRecognizing) {
                // Se o campo j√° tiver texto, come√ßamos a adicionar a partir dele
                finalTranscript = servicesTextarea.value;
                recognition.start();
            } else {
                recognition.stop();
            }
        });

        // Quando o reconhecimento come√ßa
        recognition.onstart = () => {
            isRecognizing = true;
            micButton.textContent = 'üî¥';
            micButton.classList.add('recording');
            console.log('Reconhecimento de voz iniciado.');
        };

        // Quando o reconhecimento termina
        recognition.onend = () => {
            isRecognizing = false;
            micButton.textContent = 'üé§';
            micButton.classList.remove('recording');
            console.log('Reconhecimento de voz terminado.');
        };

        // Quando um erro acontece
        recognition.onerror = (event) => {
            console.error('Erro no reconhecimento de voz:', event.error);
            if (event.error !== 'no-speech') {
                alert(`Erro no reconhecimento de voz: ${event.error}`);
            }
        };

        let finalTranscript = servicesTextarea.value;

        // Quando o navegador captura alguma fala
        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                let transcriptPart = event.results[i][0].transcript;

                if (event.results[i].isFinal) {
                    //  Processar o texto final com a nova fun√ß√£o =====
                    let textoProcessado = processarComandos(transcriptPart.trim());
                    
                    // Adiciona ao transcrito final, capitalizando a primeira letra ap√≥s um ponto ou quebra de linha
                    if (finalTranscript.endsWith('. ') || finalTranscript.endsWith('\n') || finalTranscript === '') {
                        textoProcessado = textoProcessado.charAt(0).toUpperCase() + textoProcessado.slice(1);
                    }
                    finalTranscript += (finalTranscript.endsWith('\n') || finalTranscript === '' ? '' : ' ') + textoProcessado;

                } else {
                    interimTranscript += transcriptPart;
                }
            }
    
            servicesTextarea.value = finalTranscript.replace(/\n /g, '\n') + (interimTranscript ? ' ' + interimTranscript : '');
        };

    } else {
        // Se o navegador n√£o suportar a API, esconde o bot√£o
        console.log('Este navegador n√£o suporta a Web Speech API.');
        micButton.style.display = 'none';
    }
</script>
</body>
</html>